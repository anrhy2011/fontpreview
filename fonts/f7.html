<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>字型預覽工具</title>
    <!-- 引入 Font Awesome 圖示庫 (用於愛心、眼睛、垃圾桶等圖示) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS Reset 輕量版 */
        body, h1, h2, p, ul, li, button, input, textarea, select {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif; /* 預設為通用無襯線字體，避免引入額外字體 */
            background-color: #f8f9fa;
            display: flex;
            min-height: 100vh;
            color: #333;
        }

        /* 主容器佈局 */
        .app-container {
            display: flex;
            width: 100%;
            margin: 20px auto; /* 外部留白並置中 */
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden; /* 確保圓角陰影正常顯示 */
        }

        /* 左側邊欄 */
        .sidebar {
            width: 280px;
            padding: 30px 20px;
            background-color: #f0f4f8;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 20px; /* 元素間距 */
            flex-shrink: 0; /* 防止側邊欄縮小 */
        }

        .sidebar h2 {
            color: #2c3e50;
            font-size: 1.4em;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #a7d9f7;
        }

        .sidebar-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sidebar-section label {
            display: flex;
            align-items: center;
            font-size: 1.05em;
            cursor: pointer;
            padding: 8px 0;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .sidebar-section label:hover {
            background-color: #e6f0f7;
        }

        .sidebar-section input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2); /* 讓 checkbox 更明顯 */
        }

        .sidebar-button {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.05em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            font-weight: 600;
        }

        .sidebar-button.reset {
            background-color: #dc3545;
            color: white;
            margin-top: 30px; /* 與上方內容間距 */
        }

        .sidebar-button.reset:hover {
            background-color: #c82333;
            transform: translateY(-1px);
        }

        /* 右側主內容區 */
        .main-content {
            flex-grow: 1; /* 佔據剩餘空間 */
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px; /* 調整區與字體預覽區間距 */
        }

        /* 調整功能區 (頂部) */
        .top-controls {
            background-color: #fefefe;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-text-area textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1.1em;
            line-height: 1.5;
            min-height: 80px;
            resize: vertical; /* 允許垂直拖動調整大小 */
            font-family: Arial, sans-serif; /* 確保輸入框字體為 UI 字體 */
        }

        .adjustment-row {
            display: flex;
            flex-wrap: wrap; /* 允許換行 */
            gap: 20px; /* 調整項之間的間距 */
            align-items: center;
            justify-content: space-between;
        }

        .adjustment-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex: 1 1 150px; /* 彈性項目，最小寬度150px */
            min-width: 100px;
        }

        .adjustment-item label {
            font-size: 0.95em;
            color: #555;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .adjustment-item input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            outline: none;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        .adjustment-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .adjustment-item span.value-display {
            font-size: 0.9em;
            color: #777;
            margin-top: 5px;
        }

        .toggle-group {
            display: flex;
            gap: 10px;
        }

        .toggle-button, .align-button {
            padding: 10px 15px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background-color: #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            font-size: 0.95em;
            font-weight: 500;
            color: #555;
        }

        .toggle-button.active, .align-button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .toggle-button:hover:not(.active), .align-button:hover:not(.active) {
            background-color: #e9ecef;
        }

        .align-group {
            display: flex;
            gap: 5px;
        }

        /* 字型預覽網格區 */
        .font-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); /* 自動填充，最小350px寬，並佔據剩餘空間 */
            gap: 25px; /* 卡片間距 */
            padding-top: 10px;
        }

        .font-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            padding: 15px 20px; /* 調整內邊距：上下15px，左右20px */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 200px; /* 確保卡片有最小高度 */
            transition: transform 0.2s ease;
            border: 1px solid #eee; /* 輕微邊框 */
        }

        .font-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        .font-preview-text {
            font-size: 2em; /* 預設較大的字型預覽大小 */
            line-height: 1.2;
            margin-bottom: 15px;
            overflow-wrap: break-word; /* 防止長單詞溢出 */
            white-space: pre-wrap; /* 保留換行符 */
            word-break: break-all; /* 防止字型預覽內容過長溢出 */
            flex-grow: 1;
            display: flex; /* 確保內容垂直置中，如果只有一行 */
            align-items: center; /* 垂直置中 */
            justify-content: center; /* 水平置中，預設文字 */
            min-height: 80px; /* 預覽文字最小高度 */
            transition: font-size 0.1s, letter-spacing 0.1s, line-height 0.1s, font-weight 0.1s, font-style 0.1s, text-align 0.1s;
        }

        .font-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px; /* 與預覽文字間距 */
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
        }

        .font-name {
            font-size: 1em;
            color: #555;
            font-weight: 600;
        }

        .font-actions button {
            background: none;
            border: none;
            font-size: 1.1em;
            color: #888;
            cursor: pointer;
            margin-left: 10px;
            transition: color 0.2s ease;
        }

        .font-actions button:hover {
            color: #333;
        }

        .font-actions button.favorite.active {
            color: #ff6b6b; /* 紅色愛心 */
        }

        .font-actions button.hide.active {
            color: #28a745; /* 綠色眼睛 (顯示狀態) */
        }

        .font-actions button.hide.inactive {
            color: #dc3545; /* 紅色眼睛 (隱藏狀態) */
        }

        /* 確認視窗樣式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden; /* 預設隱藏 */
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease;
        }

        .modal-overlay.visible {
            visibility: visible;
            opacity: 1;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3em;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-buttons button {
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .modal-buttons button.confirm {
            background-color: #dc3545;
            color: white;
        }

        .modal-buttons button.confirm:hover {
            background-color: #c82333;
        }

        .modal-buttons button.cancel {
            background-color: #6c757d;
            color: white;
        }

        .modal-buttons button.cancel:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
    <!-- 應用程式主容器 -->
    <div class="app-container">
        <!-- 左側邊欄 -->
        <div class="sidebar">
            <h2>分類篩選</h2>
            <div class="sidebar-section">
                <!-- 特殊分類篩選 (我的最愛、隱藏、已刪除) -->
                <label><input type="checkbox" class="category-filter special-filter" value="favorite" checked> 我的最愛字型</label>
                <label><input type="checkbox" class="category-filter special-filter" value="hidden" checked> 隱藏的字型</label>
                <label><input type="checkbox" class="category-filter special-filter" value="deleted" checked> 已刪除的字型</label>
                
                <h3 style="margin-top: 15px; margin-bottom: 5px; font-size: 1.1em; color: #444;">線上網頁字型</h3>
                <label><input type="checkbox" class="category-filter" value="ja-web" checked> 日文 (網頁)</label>
                <label><input type="checkbox" class="category-filter" value="en-web" checked> 英文及其他 (網頁)</label>

                <h3 style="margin-top: 15px; margin-bottom: 5px; font-size: 1.1em; color: #444;">本地電腦字型</h3>
                <label><input type="checkbox" class="category-filter" value="zh-tw-local" checked> 繁體中文 (本地)</label>
                <label><input type="checkbox" class="category-filter" value="ja-local" checked> 日文 (本地)</label>
            </div>

            <button class="sidebar-button reset" id="resetSettingsBtn">初始化網頁設定</button>
        </div>

        <!-- 右側主內容區 -->
        <div class="main-content">
            <!-- 頂部調整功能區 -->
            <div class="top-controls">
                <div class="input-text-area">
                    <textarea id="inputText" placeholder="請輸入想預覽的文字"></textarea>
                </div>

                <div class="adjustment-row">
                    <div class="adjustment-item">
                        <label for="fontSize">字級:</label>
                        <input type="range" id="fontSize" min="16" max="100" value="48">
                        <span class="value-display" id="fontSizeValue">48px</span>
                    </div>

                    <div class="adjustment-item">
                        <label for="letterSpacing">字距:</label>
                        <input type="range" id="letterSpacing" min="-5" max="100" step="0.1" value="0">
                        <span class="value-display" id="letterSpacingValue">0px</span>
                    </div>

                    <div class="adjustment-item">
                        <label for="lineHeight">行距:</label>
                        <input type="range" id="lineHeight" min="0.8" max="2.5" step="0.1" value="1.2">
                        <span class="value-display" id="lineHeightValue">1.2</span>
                    </div>

                    <div class="toggle-group">
                        <button class="toggle-button" id="boldToggle">粗體</button>
                        <button class="toggle-button" id="italicToggle">斜體</button>
                    </div>

                    <div class="align-group">
                        <button class="align-button active" id="alignLeft" data-align="left">左對齊</button>
                        <button class="align-button" id="alignCenter" data-align="center">置中</button>
                        <button class="align-button" id="alignRight" data-align="right">右對齊</button>
                    </div>
                </div>
            </div>

            <!-- 字型預覽網格區 -->
            <div class="font-grid" id="fontGrid">
                <!-- 字型卡片將透過 JavaScript 動態生成 -->
            </div>
        </div>
    </div>

    <!-- 自定義確認視窗 - 初始化設定 -->
    <div class="modal-overlay" id="confirmationModal">
        <div class="modal-content">
            <h3>您確定要初始化所有設定嗎？</h3>
            <p>這將會清除您的所有「我的最愛」、「隱藏」和「已刪除」字型設定，並恢復到預設狀態。</p>
            <div class="modal-buttons">
                <button class="confirm" id="confirmResetBtn">確定</button>
                <button class="cancel" id="cancelResetBtn">取消</button>
            </div>
        </div>
    </div>

    <!-- 自定義確認視窗 - 刪除字型 -->
    <div class="modal-overlay" id="deleteConfirmationModal">
        <div class="modal-content">
            <h3 id="deleteModalTitle"></h3>
            <p>這將會從您的列表中永久移除此字型，並將其歸類到「已刪除的字型」篩選中。</p>
            <div class="modal-buttons">
                <button class="confirm" id="confirmDeleteBtn">確定移除</button>
                <button class="cancel" id="cancelDeleteBtn">取消</button>
            </div>
        </div>
    </div>

    <script>
        // JavaScript 部分：網頁的互動邏輯

        // --- 核心變數和 DOM 元素獲取 ---
        const inputText = document.getElementById('inputText');
        const fontSizeInput = document.getElementById('fontSize');
        const fontSizeValueDisplay = document.getElementById('fontSizeValue');
        const letterSpacingInput = document.getElementById('letterSpacing');
        const letterSpacingValueDisplay = document.getElementById('letterSpacingValue');
        const lineHeightInput = document.getElementById('lineHeight');
        const lineHeightValueDisplay = document.getElementById('lineHeightValue');
        const boldToggleBtn = document.getElementById('boldToggle');
        const italicToggleBtn = document.getElementById('italicToggle');
        const alignButtons = document.querySelectorAll('.align-button');
        const fontGrid = document.getElementById('fontGrid');
        const categoryFilters = document.querySelectorAll('.category-filter');
        const resetSettingsBtn = document.getElementById('resetSettingsBtn');

        // 確認視窗相關元素 - 初始化設定
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmResetBtn = document.getElementById('confirmResetBtn');
        const cancelResetBtn = document.getElementById('cancelResetBtn');

        // 確認視窗相關元素 - 刪除字型
        const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const deleteModalTitle = document.getElementById('deleteModalTitle');

        let fontIdToDelete = null; // 用於儲存要刪除的字型 ID

        // --- 字型資料定義 ---
        const baseWebFonts = [
            // 自訂日文字型
            {
                id: 'hangyaku-g3rpg',
                name: '叛逆明朝',
                category: 'ja-web',
                type: 'custom',
                fullUrls: {
                    // 相對路徑: f7.html 和字型檔在同一個 'fonts' 資料夾下
                    woff2: 'hangyaku-g3rpg-webfont.woff2', 
                },
                fontWeight: 'normal',
                fontStyle: 'normal'
            },
            {
                id: 'rocknrollone-regular',
                name: 'ロックンロール One-Regular',
                category: 'ja-web',
                type: 'custom',
                fullUrls: {
                    // 相對路徑
                    woff2: 'rocknrollone-regular-webfont.woff2', 
                },
                fontWeight: 'normal',
                fontStyle: 'normal'
            },
            {
                id: 'ydwaosagi',
                name: 'あおさぎ青鷺明朝',
                category: 'ja-web',
                type: 'custom',
                fullUrls: {
                    // 相對路徑
                    woff2: 'ydwaosagi-webfont.woff2', 
                },
                fontWeight: 'normal',
                fontStyle: 'normal'
            },
            // 線上英文字型範例
            {
                id: 'new-y2k-regular',
                name: 'New_y2kフォント',
                category: 'en-web',
                type: 'custom',
                fullUrls: {
                    // 相對路徑
                    woff2: 'new_y2k-regular-webfont.woff2', 
                },
                fontWeight: 'normal',
                fontStyle: 'normal'
            },
        ];

        // 本地日文字型 及 本地繁體中文字型
        const baseLocalFonts = [
            { id: 'local-851mkpop', name: '851MkPOP', category: 'ja-local', type: 'local' },
            { id: 'local-aoyagireisyo2', name: 'aoyagireisyo2', category: 'ja-local', type: 'local' },
            { id: 'local-biz-udgothic', name: 'BIZ UDGothic', category: 'ja-local', type: 'local' },
            { id: 'local-biz-udmincho', name: 'BIZ UDMIncho', category: 'ja-local', type: 'local' },
            { id: 'local-genei-latemin-v2', name: 'GenEi LateMin v2', category: 'ja-local', type: 'local' },
            { id: 'local-hiragino-maru-gothic-pron', name: 'Hiragino Maru Gothic ProN', category: 'ja-local', type: 'local' },
            { id: 'local-hiragino-mincho-pron', name: 'Hiragino Mincho ProN', category: 'ja-local', type: 'local' },
            { id: 'local-hiragino-sans', name: 'Hiragino Sans', category: 'ja-local', type: 'local' },
            { id: 'local-klee', name: 'Klee', category: 'ja-local', type: 'local' },
            { id: 'local-koku-mincho-regular', name: 'Koku Mincho Regular', category: 'ja-local', type: 'local' },
            { id: 'local-kswgoryunewn', name: 'KswGoryuNewN', category: 'ja-local', type: 'local' },
            { id: 'local-osaka', name: 'Osaka', category: 'ja-local', type: 'local' },
            { id: 'local-planetarium', name: 'Planetarium', category: 'ja-local', type: 'local' },
            { id: 'local-pto-utamins2', name: 'PtO-UtaMinS2', category: 'ja-local', type: 'local' },
            { id: 'local-tanuki-permanent-marker', name: 'Tanuki Permanent Marker', category: 'ja-local', type: 'local' },
            { id: 'local-toppan-bunkyu-gothic', name: 'Toppan Bunkyu Gothic', category: 'ja-local', type: 'local' },
            { id: 'local-toppan-bunkyu-midashi-gothic', name: 'Toppan Bunkyu Midashi Gothic', category: 'ja-local', type: 'local' },
            { id: 'local-toppan-bunkyu-midashi-mincho', name: 'Toppan Bunkyu Midashi Mincho', category: 'ja-local', type: 'local' },
            { id: 'local-toppan-bunkyu-mincho', name: 'Toppan Bunkyu Mincho', category: 'ja-local', type: 'local' },
            { id: 'local-tsukushi-a-round-gothic', name: 'Tsukushi A Round Gothic', category: 'ja-local', type: 'local' },
            { id: 'local-tsukushi-b-round-gothic', name: 'Tsukushi B Round Gothic', category: 'ja-local', type: 'local' },
            { id: 'local-urwheiseimincho-bold', name: 'URWHeiseiMincho-Bold', category: 'ja-local', type: 'local' },
            { id: 'local-urwmarugothic-light', name: 'URWMaruGothic-Light', category: 'ja-local', type: 'local' },
            { id: 'local-yugothic', name: 'YuGothic', category: 'ja-local', type: 'local' },
            { id: 'local-yukyokasho', name: 'YuKyokasho', category: 'ja-local', type: 'local' },
            { id: 'local-yukyokasho-yoko', name: 'YuKyokasho Yoko', category: 'ja-local', type: 'local' },
            { id: 'local-yumincho', name: 'YuMincho', category: 'ja-local', type: 'local' },
            { id: 'local-yumincho-36p-kana', name: 'YuMincho +36p Kana', category: 'ja-local', type: 'local' },
            // 新增的本地繁體中文字型 (根據圖片提供)
            { id: 'local-source-han-sans-tw', name: '思源黑體 TW', category: 'zh-tw-local', type: 'local' },
            { id: 'local-hwa-kang-new-go-font', name: '華康新特明體', category: 'zh-tw-local', type: 'local' },
            { id: 'local-hwa-kang-new-go-font-p', name: '華康新特明體(P)', category: 'zh-tw-local', type: 'local' },
            { id: 'local-hwa-kang-fang-song-w5', name: '華康節藝體W5', category: 'zh-tw-local', type: 'local' },
        ];
        
        // 合併所有字型，這是用於渲染的基礎列表
        let currentAllFonts = [...baseWebFonts, ...baseLocalFonts]; 

        // --- 狀態變數 ---
        let currentText = "請輸入文字來預覽效果";
        let currentFontSize = parseInt(fontSizeInput.value);
        let currentLetterSpacing = parseFloat(letterSpacingInput.value);
        let currentLineHeight = parseFloat(lineHeightInput.value);
        let isBold = false;
        let isItalic = false;
        let currentAlignment = 'left'; // 預設左對齊

        // 從 localStorage 加載偏好設定，確保初始化為空陣列如果沒有存儲
        let favoriteFontIds = JSON.parse(localStorage.getItem('favoriteFontIds')) || [];
        let hiddenFontIds = JSON.parse(localStorage.getItem('hiddenFontIds')) || [];
        let deletedFontIds = JSON.parse(localStorage.getItem('deletedFontIds')) || [];

        // --- 功能函數 ---

        /**
         * 動態載入自訂網頁字型 (@font-face 規則)。
         * 本地字型不需要此函數。
         * @param {Object} fontObj 字型物件
         */
        function loadFont(fontObj) {
            const fontId = fontObj.id; // 用於檢查是否已載入過

            // 檢查是否已載入過此字體 (透過檢查 style 標籤)
            if (document.head.querySelector(`style[data-font-id="${fontId}"]`)) {
                return; // 已載入過
            }

            if (fontObj.type === 'custom' && fontObj.fullUrls) {
                let fontFaceSrc = [];
                if (fontObj.fullUrls.woff2) {
                    fontFaceSrc.push(`url('${fontObj.fullUrls.woff2}') format('woff2')`);
                }
                if (fontObj.fullUrls.woff) { 
                    fontFaceSrc.push(`url('${fontObj.fullUrls.woff}') format('woff')`);
                }

                if (fontFaceSrc.length === 0) {
                    console.warn(`Custom web font ${fontObj.name} (${fontObj.id}) has no valid font file definition.`);
                    return;
                }

                const style = document.createElement('style');
                style.setAttribute('data-font-id', fontId); // 添加 data 屬性以便檢查
                style.textContent = `
                    @font-face {
                        font-family: '${fontObj.name}';
                        src: ${fontFaceSrc.join(', ')};
                        font-weight: ${fontObj.fontWeight || 'normal'};
                        font-style: ${fontObj.fontStyle || 'normal'};
                        display: swap;
                    }
                `;
                document.head.appendChild(style);
                console.log(`Attempting to load custom font: ${fontObj.name}`);
            }
        }

        /**
         * 渲染或更新所有字型預覽卡片
         */
        function renderFontCards() {
            fontGrid.innerHTML = ''; // 清空現有卡片

            // 重新組合所有字型
            currentAllFonts = [...baseWebFonts, ...baseLocalFonts];

            // 獲取所有啟用中的分類篩選器
            const activeCategories = Array.from(categoryFilters)
                                        .filter(checkbox => checkbox.checked)
                                        .map(checkbox => checkbox.value);

            const fontsToDisplay = [];

            // 確保 localStorage 中的 ID 仍然存在於當前字型列表中，並清除無效 ID
            favoriteFontIds = favoriteFontIds.filter(id => currentAllFonts.some(font => font.id === id));
            localStorage.setItem('favoriteFontIds', JSON.stringify(favoriteFontIds));

            hiddenFontIds = hiddenFontIds.filter(id => currentAllFonts.some(font => font.id === id));
            localStorage.setItem('hiddenFontIds', JSON.stringify(hiddenFontIds));

            deletedFontIds = deletedFontIds.filter(id => currentAllFonts.some(font => font.id === id));
            localStorage.setItem('deletedFontIds', JSON.stringify(deletedFontIds));


            currentAllFonts.forEach(font => {
                const isFavorite = favoriteFontIds.includes(font.id);
                const isHidden = hiddenFontIds.includes(font.id);
                const isDeleted = deletedFontIds.includes(font.id);

                let shouldDisplay = false;

                // 篩選邏輯：
                // 如果字型在 "已刪除的字型" 列表中，只有勾選 "deleted" 時才顯示
                if (isDeleted) {
                    shouldDisplay = activeCategories.includes('deleted');
                } 
                // 如果字型在 "隱藏的字型" 列表中，且未被刪除，只有勾選 "hidden" 時才顯示
                else if (isHidden) {
                    shouldDisplay = activeCategories.includes('hidden');
                }
                // 如果字型在 "我的最愛" 列表中，且未被隱藏或刪除，只有勾選 "favorite" 時才顯示
                else if (isFavorite) {
                    shouldDisplay = activeCategories.includes('favorite');
                }
                // 如果字型沒有特殊狀態 (非最愛、非隱藏、非刪除)，則根據其原始分類顯示
                else {
                    // 檢查是否有任何非特殊篩選器被勾選 (如 ja-web, en-web, zh-tw-local 等)
                    const nonSpecialFiltersActive = activeCategories.some(cat => !['favorite', 'hidden', 'deleted'].includes(cat));
                    
                    // 如果沒有任何特殊篩選器被勾選，並且字型符合其原始分類
                    if (nonSpecialFiltersActive && activeCategories.includes(font.category)) {
                        shouldDisplay = true;
                    } 
                    // 特殊情況：如果所有篩選器都被取消勾選，則什麼都不顯示
                    if (activeCategories.length === 0) {
                        shouldDisplay = false;
                    }
                }
                
                if (shouldDisplay) {
                    fontsToDisplay.push(font);
                }
            });

            // 如果沒有字型符合篩選條件，顯示提示
            if (fontsToDisplay.length === 0) {
                fontGrid.innerHTML = '<p style="text-align: center; color: #777; width: 100%; grid-column: 1 / -1; margin-top: 50px;">沒有符合篩選條件的字型。</p>';
                return;
            }

            fontsToDisplay.forEach(font => {
                // 只有自訂網頁字型才需要動態載入 @font-face 規則
                if (font.type === 'custom') {
                    loadFont(font);
                }

                const card = document.createElement('div');
                card.className = 'font-card';
                card.setAttribute('data-font-id', font.id); // 便於查找和操作

                const previewTextElement = document.createElement('div');
                previewTextElement.className = 'font-preview-text';
                previewTextElement.textContent = currentText;
                previewTextElement.style.fontFamily = `'${font.name}', sans-serif`; 
                applyFontAdjustments(previewTextElement);

                const fontInfoElement = document.createElement('div');
                fontInfoElement.className = 'font-info';

                const fontNameElement = document.createElement('span');
                fontNameElement.className = 'font-name';
                fontNameElement.textContent = font.name;

                const fontActionsElement = document.createElement('div');
                fontActionsElement.className = 'font-actions';

                // 愛心按鈕
                const isFavoriteForCard = favoriteFontIds.includes(font.id); 
                const favoriteBtn = document.createElement('button');
                favoriteBtn.className = 'favorite';
                favoriteBtn.innerHTML = `<i class="${isFavoriteForCard ? 'fas' : 'far'} fa-heart"></i>`; 
                if (isFavoriteForCard) favoriteBtn.classList.add('active');
                favoriteBtn.title = isFavoriteForCard ? '從我的最愛移除' : '加入我的最愛';
                favoriteBtn.addEventListener('click', () => toggleFavorite(font.id, favoriteBtn));

                // 眼睛按鈕 (隱藏/顯示)
                const hideBtn = document.createElement('button');
                hideBtn.className = 'hide';
                const isCurrentlyHidden = hiddenFontIds.includes(font.id); 
                hideBtn.innerHTML = `<i class="fas fa-eye${isCurrentlyHidden ? '-slash' : ''}"></i>`; 
                hideBtn.title = isCurrentlyHidden ? '從隱藏列表中恢復' : '隱藏此字型';
                hideBtn.addEventListener('click', () => toggleHiddenStatus(font.id, hideBtn));

                // 垃圾桶按鈕 (刪除)
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete';
                deleteBtn.innerHTML = `<i class="fas fa-trash"></i>`;
                deleteBtn.title = '永久刪除此字型';
                deleteBtn.addEventListener('click', () => showDeleteConfirmationModal(font.id));

                fontActionsElement.appendChild(favoriteBtn);
                fontActionsElement.appendChild(hideBtn);
                fontActionsElement.appendChild(deleteBtn);

                fontInfoElement.appendChild(fontNameElement);
                fontInfoElement.appendChild(fontActionsElement);

                card.appendChild(previewTextElement);
                card.appendChild(fontInfoElement);
                fontGrid.appendChild(card);
            });
        }

        /**
         * 應用當前的字型調整樣式到指定的預覽元素。
         * @param {HTMLElement} element 要應用樣式的元素
         */
        function applyFontAdjustments(element) {
            element.style.fontSize = `${currentFontSize}px`;
            element.style.letterSpacing = `${currentLetterSpacing}px`;
            element.style.lineHeight = `${currentLineHeight}`;
            element.style.fontWeight = isBold ? 'bold' : 'normal';
            element.style.fontStyle = isItalic ? 'italic' : 'normal';
            element.style.textAlign = currentAlignment;
        }

        /**
         * 更新所有字型預覽卡片的樣式。
         */
        function updateAllFontCardStyles() {
            document.querySelectorAll('.font-preview-text').forEach(previewElement => {
                applyFontAdjustments(previewElement);
            });
        }

        /**
         * 切換字型為我的最愛狀態
         * @param {string} fontId 字型 ID
         * @param {HTMLElement} button 愛心按鈕元素
         */
        function toggleFavorite(fontId, button) {
            if (favoriteFontIds.includes(fontId)) {
                // 如果已經在最愛列表中，則從中移除
                favoriteFontIds = favoriteFontIds.filter(id => id !== fontId);
            } else {
                // 如果不在最愛列表中，則加入
                favoriteFontIds.push(fontId);
                // 確保互斥性：從隱藏和刪除列表中移除
                hiddenFontIds = hiddenFontIds.filter(id => id !== fontId);
                deletedFontIds = deletedFontIds.filter(id => id !== fontId);
            }
            localStorage.setItem('favoriteFontIds', JSON.stringify(favoriteFontIds));
            localStorage.setItem('hiddenFontIds', JSON.stringify(hiddenFontIds));
            localStorage.setItem('deletedFontIds', JSON.stringify(deletedFontIds));
            renderFontCards(); // 重新渲染以更新篩選
        }

        /**
         * 切換字型的隱藏狀態
         * @param {string} fontId 字型 ID
         * @param {HTMLElement} button 眼睛按鈕元素
         */
        function toggleHiddenStatus(fontId, button) {
            if (hiddenFontIds.includes(fontId)) {
                // 如果已經在隱藏列表中，則從中移除 (恢復顯示)
                hiddenFontIds = hiddenFontIds.filter(id => id !== fontId);
            } else {
                // 如果不在隱藏列表中，則加入 (隱藏)
                hiddenFontIds.push(fontId);
                // 確保互斥性：從我的最愛和刪除列表中移除
                favoriteFontIds = favoriteFontIds.filter(id => id !== fontId);
                deletedFontIds = deletedFontIds.filter(id => id !== fontId);
            }
            localStorage.setItem('favoriteFontIds', JSON.stringify(favoriteFontIds));
            localStorage.setItem('hiddenFontIds', JSON.stringify(hiddenFontIds));
            localStorage.setItem('deletedFontIds', JSON.stringify(deletedFontIds));
            renderFontCards(); // 重新渲染以更新篩選狀態
        }


        /**
         * 顯示刪除確認彈窗
         * @param {string} fontId 要刪除的字型 ID
         */
        function showDeleteConfirmationModal(fontId) {
            fontIdToDelete = fontId; // 儲存要刪除的字型 ID
            const fontName = currentAllFonts.find(f => f.id === fontId)?.name || fontId;
            deleteModalTitle.textContent = `您確定要永久刪除「${fontName}」嗎？`;
            deleteConfirmationModal.classList.add('visible');
        }

        /**
         * 隱藏刪除確認彈窗
         */
        function hideDeleteConfirmationModal() {
            deleteConfirmationModal.classList.remove('visible');
            fontIdToDelete = null; // 清空儲存的 ID
        }

        /**
         * 執行永久刪除單個字型 (從列表中移除，並標記為已刪除)
         */
        function executeDeleteFontPermanently() {
            if (!fontIdToDelete) return; // 如果沒有要刪除的字型 ID，則返回

            // 將字型 ID 加入到 deletedFontIds
            if (!deletedFontIds.includes(fontIdToDelete)) {
                deletedFontIds.push(fontIdToDelete);
            }
            // 確保互斥性：從我的最愛和隱藏列表中移除
            favoriteFontIds = favoriteFontIds.filter(id => id !== fontIdToDelete);
            hiddenFontIds = hiddenFontIds.filter(id => id !== fontIdToDelete);
            
            localStorage.setItem('favoriteFontIds', JSON.stringify(favoriteFontIds));
            localStorage.setItem('hiddenFontIds', JSON.stringify(hiddenFontIds));
            localStorage.setItem('deletedFontIds', JSON.stringify(deletedFontIds));

            hideDeleteConfirmationModal(); // 隱藏確認視窗
            renderFontCards(); // 重新渲染以更新顯示
        }


        /**
         * 顯示初始化設定確認彈窗
         */
        function showConfirmationModal() {
            confirmationModal.classList.add('visible');
        }

        /**
         * 隱藏初始化設定確認彈窗
         */
        function hideConfirmationModal() {
            confirmationModal.classList.remove('visible');
        }

        /**
         * 初始化所有設定 (清除 localStorage)
         */
        function resetAllSettings() {
            localStorage.removeItem('favoriteFontIds');
            localStorage.removeItem('hiddenFontIds');
            localStorage.removeItem('deletedFontIds');
            
            favoriteFontIds = [];
            hiddenFontIds = [];
            deletedFontIds = [];

            // 重置 UI 狀態
            inputText.value = "請輸入文字來預覽效果";
            fontSizeInput.value = 48;
            letterSpacingInput.value = 0;
            lineHeightInput.value = 1.2;
            boldToggleBtn.classList.remove('active');
            italicToggleBtn.classList.remove('active');
            alignButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById('alignLeft').classList.add('active'); // 預設左對齊
            currentText = "請輸入文字來預覽效果";
            currentFontSize = 48;
            currentLetterSpacing = 0;
            currentLineHeight = 1.2;
            isBold = false;
            isItalic = false;
            currentAlignment = 'left';

            // 重置分類篩選器 (保持預設勾選狀態)
            categoryFilters.forEach(checkbox => checkbox.checked = true); 

            // 更新顯示值
            fontSizeValueDisplay.textContent = `${currentFontSize}px`;
            letterSpacingValueDisplay.textContent = `${currentLetterSpacing}px`;
            lineHeightValueDisplay.textContent = `${currentLineHeight}`;

            // 重新載入所有初始字型
            baseWebFonts.filter(font => font.type === 'custom').forEach(font => loadFont(font));
            
            renderFontCards(); // 重新渲染所有字型卡片
            hideConfirmationModal(); // 隱藏確認視窗
        }

        // --- 事件監聽器設定 ---

        // 頁面載入完成時執行初始化
        window.onload = function() {
            // 載入所有自訂網頁字型
            baseWebFonts.filter(font => font.type === 'custom').forEach(font => loadFont(font));

            // 首次渲染字型卡片
            renderFontCards();

            // 將預設文字設定到輸入框
            inputText.value = currentText;

            // 初始化滑桿顯示值
            fontSizeValueDisplay.textContent = `${currentFontSize}px`;
            letterSpacingValueDisplay.textContent = `${currentLetterSpacing}px`;
            lineHeightValueDisplay.textContent = `${currentLineHeight}`;
        };


        // 輸入文字變動事件
        inputText.addEventListener('input', () => {
            currentText = inputText.value;
            // 如果輸入框為空，顯示預設文字
            if (currentText.trim() === '') {
                currentText = "請輸入文字來預覽效果";
            }
            document.querySelectorAll('.font-preview-text').forEach(el => {
                el.textContent = currentText;
            });
        });

        // 字級調整事件
        fontSizeInput.addEventListener('input', (event) => {
            currentFontSize = parseInt(event.target.value);
            fontSizeValueDisplay.textContent = `${currentFontSize}px`;
            updateAllFontCardStyles();
        });

        // 字距調整事件
        letterSpacingInput.addEventListener('input', (event) => {
            currentLetterSpacing = parseFloat(event.target.value);
            letterSpacingValueDisplay.textContent = `${currentLetterSpacing}px`;
            updateAllFontCardStyles();
        });

        // 行距調整事件
        lineHeightInput.addEventListener('input', (event) => {
            currentLineHeight = parseFloat(event.target.value);
            lineHeightValueDisplay.textContent = `${currentLineHeight}`;
            updateAllFontCardStyles();
        });

        // 粗體切換事件
        boldToggleBtn.addEventListener('click', () => {
            isBold = !isBold;
            boldToggleBtn.classList.toggle('active', isBold);
            updateAllFontCardStyles();
        });

        // 斜體切換事件
        italicToggleBtn.addEventListener('click', () => {
            isItalic = !isItalic;
            italicToggleBtn.classList.toggle('active', isItalic);
            updateAllFontCardStyles();
        });

        // 對齊方式切換事件
        alignButtons.forEach(button => {
            button.addEventListener('click', () => {
                alignButtons.forEach(btn => btn.classList.remove('active')); // 移除所有按鈕的 active 狀態
                button.classList.add('active'); // 為當前點擊的按鈕添加 active 狀態
                currentAlignment = button.dataset.align; // 取得對齊方式
                updateAllFontCardStyles();
            });
        });

        // 分類篩選器事件
        categoryFilters.forEach(checkbox => {
            checkbox.addEventListener('change', renderFontCards);
        });

        // 初始化網頁設定按鈕事件
        resetSettingsBtn.addEventListener('click', showConfirmationModal);

        // 確認彈窗按鈕事件 (初始化)
        confirmResetBtn.addEventListener('click', resetAllSettings);
        cancelResetBtn.addEventListener('click', hideConfirmationModal);

        // 如果點擊初始化彈窗外部，也隱藏彈窗
        confirmationModal.addEventListener('click', (event) => {
            if (event.target === confirmationModal) {
                hideConfirmationModal();
            }
        });

        // 確認彈窗按鈕事件 (刪除)
        confirmDeleteBtn.addEventListener('click', executeDeleteFontPermanently);
        cancelDeleteBtn.addEventListener('click', hideDeleteConfirmationModal);

        // 如果點擊刪除彈窗外部，也隱藏彈窗
        deleteConfirmationModal.addEventListener('click', (event) => {
            if (event.target === deleteConfirmationModal) {
                hideDeleteConfirmationModal();
            }
        });
    </script>
</body>
</html>
